pipeline {
    agent any

    parameters {
        string(name: 'ALERT_ID', defaultValue: '', description: 'ID de la alerta (ej: 20251016_211645)')
        string(name: 'ALERT_NAME', defaultValue: '', description: 'Nombre descriptivo de la alerta')
        string(name: 'SCRIPT_NAME', defaultValue: '', description: 'Nombre del script ejecutado (con .py)')
        string(name: 'STATUS', defaultValue: 'error', description: 'falso_positivo / alarma_confirmada / error')
        string(name: 'ERROR_MSG', defaultValue: '', description: 'Mensaje de error si aplica')
        string(name: 'SCREENSHOTS', defaultValue: '', description: 'Rutas de capturas separadas por espacio')
    }

    stages {
        stage('Copiar código del orquestador') {
            steps {
                copyArtifacts projectName: 'GSIT_Alerts/00_Orquestador_Principal',
                              selector: lastSuccessful(),
                              filter: 'utils/**, email_templates/**',
                              target: '',
                              flatten: false
                sh 'ls -la utils/ email_templates/ || true'
            }
        }

        stage('Copiar artefactos de ejecución') {
            steps {
                copyArtifacts projectName: 'GSIT_Alerts/03_Ejecutar_Script',
                              selector: upstream(),
                              filter: 'runs/**/screenshots/*.png, runs/**/result.json',
                              target: 'artifacts/',
                              flatten: false
            }
        }

        stage('Preparar entorno Python') {
            steps {
                sh '''
                    python3 -m venv venv
                    ./venv/bin/pip install --upgrade pip > /dev/null
                    ./venv/bin/pip install jinja2 beautifulsoup4 > /dev/null
                '''
            }
        }

        stage('Generar correo HTML + destinatarios') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'email-alertas-user',
                                                usernameVariable: 'EMAIL_USER',
                                                passwordVariable: 'EMAIL_PASS')]) {
                    sh '''
                        export PYTHONPATH="$WORKSPACE:$PYTHONPATH"

                        ./venv/bin/python - <<'PY'
import os
from utils.email_generator import (
    generate_false_positive_email,
    generate_error_email,
    generate_alert_email
)

script_name = "${params.SCRIPT_NAME}"
alert_name  = "${params.ALERT_NAME}"
alert_id    = "${params.ALERT_ID}"
status      = "${params.STATUS}".strip().lower()

# Rutas reales de capturas (para incrustar o adjuntar)
screenshots = "${params.SCREENSHOTS}".strip().split()

if status == "falso_positivo":
    html = generate_false_positive_email(
        script_name=script_name,
        alert_name=alert_name,
        alert_type="GSIT",
        alert_id=alert_id,
        job_name="GSIT_Alerts"
    )
    recipients = "ecommerceoperaciones01@gmail.com,"

elif status == "alarma_confirmada":
    # Usa la plantilla específica del script (ej: acces_frontal_emd.html)
    base_name = os.path.basename(script_name).replace(".py", "")
    body_text = "Alerta real confirmada por automatización GSIT"
    html, excel_data = generate_alert_email(
        script_name=base_name,
        body=body_text,
        alert_type="ACTIVA",
        alert_id=alert_id
    )
    recipients = "ecommerceoperaciones01@gmail.com,"

else:  # error
    html = generate_error_email(
        script_name=script_name,
        alert_name=alert_name,
        alert_type="ERROR EN AUTOMATIZACIÓN",
        alert_id=alert_id,
        error_message="${params.ERROR_MSG}" or "Error desconocido durante ejecución",
        retry_count=0,
        max_retries=3
    )
    recipients = "ecommerceoperaciones01@gmail.com,"

# Guardar HTML y destinatarios
with open("email_final.html", "w", encoding="utf-8") as f:
    f.write(html)
with open("recipients.txt", "w", encoding="utf-8") as f:
    f.write(recipients)

print(f"Correo generado → {status.upper()} para: {recipients}")
PY
                    '''
                }
            }
        }

        stage('Enviar correo') {
            steps {
                script {
                    def recip = readFile('recipients.txt').trim()
                    def attachments = (params.STATUS == 'falso_positivo' || params.STATUS == 'alarma_confirmada') ? params.SCREENSHOTS : ''

                    emailext(
                        subject: "GSIT • ${params.ALERT_NAME} [${params.ALERT_ID}] • ${params.STATUS.toUpperCase()}",
                        body: '${FILE,path="email_final.html"}',
                        mimeType: 'text/html',
                        to: 'rpinheiro@viewnext.com',
                        from: 'gsit-alertas@viewnext.com',
                        replyTo: 'no-reply@viewnext.com',
                        attachmentsPattern: attachments,
                        attachLog: params.STATUS == 'error'
                    )
                    echo "Correo enviado correctamente a: ${recip}"
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'email_final.html, recipients.txt, artifacts/**', allowEmptyArchive: true
            cleanWs()
        }
    }
}