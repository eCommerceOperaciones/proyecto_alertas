pipeline {
    agent any

    parameters {
        string(name: 'ALERT_ID',      defaultValue: '', description: 'ID de la alerta')
        string(name: 'ALERT_NAME',    defaultValue: '', description: 'Nombre descriptivo de la alerta')
        string(name: 'SCRIPT_NAME',   defaultValue: '', description: 'Nombre del script ejecutado (con .py o sin)')
        string(name: 'STATUS',        defaultValue: 'error', description: 'falso_positivo / alarma_confirmada / error')
        string(name: 'ERROR_MSG',     defaultValue: '', description: 'Mensaje de error si aplica')
        string(name: 'SCREENSHOTS',   defaultValue: '', description: 'Rutas de capturas separadas por espacio (se rellenará automáticamente)')
    }

    stages {
        stage('Copiar código del orquestador') {
            steps {
                copyArtifacts projectName: 'GSIT_Alerts/00_Orquestador_Principal',
                              selector: lastSuccessful(),
                              filter: 'utils/**, email_templates/**',
                              target: '',
                              flatten: false
            }
        }

        stage('Copiar capturas y resultados') {
            steps {
                copyArtifacts projectName: 'GSIT_Alerts/03_Ejecutar_Script',
                              selector: upstream(),
                              filter: 'artifacts/screenshots/*.png, runs/**/result.json',
                              target: 'artifacts/',
                              flatten: false
                sh 'ls -la artifacts/screenshots/ || true'
            }
        }

        stage('Preparar Python + Jinja2') {
            steps {
                sh '''
                    python3 -m venv venv
                    ./venv/bin/pip install --upgrade pip > /dev/null
                    ./venv/bin/pip install jinja2 > /dev/null
                '''
            }
        }

        stage('Generar correo HTML') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'email-alertas-user',
                                                 usernameVariable: 'EMAIL_USER',
                                                 passwordVariable: 'EMAIL_PASS')]) {
                    sh """
                        export PYTHONPATH="\$WORKSPACE:\$PYTHONPATH"

                        ./venv/bin/python - <<'PY'
import os
import re
from jinja2 import Template

# -------------------------------
# Cargar plantilla
#---------------
def load_template(name):
    path = os.path.join("email_templates", f"{name}.html")
    with open(path, "r", encoding="utf-8") as f:
        return f.read()

# -------------------------------
# Parámetros que vienen de Jenkins
# (¡AHORA SÍ SE EXPANDEN!)
# -------------------------------
script_name = "${params.SCRIPT_NAME}".strip()
alert_name   = "${params.ALERT_NAME}".strip()
alert_id     = "${params.ALERT_ID}".strip() or "sin-id"
status_raw   = "${params.STATUS}".strip().lower()
error_msg    = "${params.ERROR_MSG}".strip()
screenshots  = "${params.SCREENSHOTS}".strip()

print("STATUS recibido →", status_raw)
print("SCREENSHOTS recibido →", screenshots)

# -------------------------------
# Generación según tipo
# -------------------------------
if status_raw == "falso_positivo" or status_raw == "falso_positivo":
    template_str = load_template("false_positive")
    template = Template(template_str)
    html = template.render(
        script_name = script_name,
        alert_name  = alert_name,
        alert_type  = "GSIT",
        alert_id    = alert_id,
        job_name    = os.environ.get("JOB_NAME", "GSIT_Alerts"),
        build_number = os.environ.get("BUILD_NUMBER", "?")
    )
    recipients = "rpinheiro@viewnext.com"

elif status_raw == "alarma_confirmada":
    template_str = load_template("alert_active")
    template = Template(template_str)
    html = template.render(alert_name=alert_name, alert_id=alert_id)
    recipients = "ecommerceoperaciones01@gmail.com"

else:  # error
    template_str = load_template("error")
    template = Template(template_str)
    html = template.render(
        script_name   = script_name,
        alert_name    = alert_name,
        alert_type    = "ERROR EN AUTOMATIZACIÓN",
        alert_id      = alert_id,
        error_message = error_msg or "Error desconocido",
        retry_count   = 0,
        max_retries   = 3
    )
    recipients = "ecommerceoperaciones01@gmail.com"

# Guardar resultados
with open("email_final.html", "w", encoding="utf-8") as f:
    f.write(html)
with open("recipients.txt", "w", encoding="utf-8") as f:
    f.write(recipients)

print("Correo generado correctamente para:", recipients)
PY
                    """
                }
            }
        }

       stage('Enviar correo') {
            steps {
                script {
                    def htmlBody = readFile('email_final.html')
                    def recip    = readFile('recipients.txt').trim()

                    // CLAVE: ahora funciona siempre
                    def attachPattern = (params.SCREENSHOTS == '*') ? 'artifacts/screenshots/*.png' : ''

                    emailext(
                        subject: "GSIT • ${params.ALERT_NAME} [${params.ALERT_ID}] • ${params.STATUS.replace('_',' ').toUpperCase()}",
                        body: htmlBody,
                        mimeType: 'text/html',
                        to: recip,
                        from: 'alertas-gsit@dominio.com',
                        replyTo: 'alertas-gsit@dominio.com',
                        attachmentsPattern: attachPattern,
                        attachLog: params.STATUS.toLowerCase().contains('error')
                    )
                    echo "Correo enviado correctamente a ${recip} ${attachPattern ? 'con capturas adjuntas' : 'sin adjuntos'}"
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'email_final.html, recipients.txt, artifacts/screenshots/*.png', allowEmptyArchive: true
            cleanWs()
        }
    }
}